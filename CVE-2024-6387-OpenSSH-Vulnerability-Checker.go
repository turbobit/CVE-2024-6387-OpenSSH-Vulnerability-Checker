package main

import (
    "fmt"
    "os/exec"
    "regexp"
    "strconv"
    "strings"
)

func getOpenSSHVersion() string {
    cmd := exec.Command("ssh", "-V")
    output, err := cmd.CombinedOutput()
    if err != nil {
        fmt.Println("Error executing command:", err)
        return ""
    }
    versionInfo := strings.TrimSpace(string(output))
    return versionInfo
}

func isVulnerable(versionInfo string) string {
    re := regexp.MustCompile(`OpenSSH(?:_for_Windows)?_([\d\.]+)p(\d+)`)
    match := re.FindStringSubmatch(versionInfo)
    if match == nil {
        return "Unknown version format"
    }

    majorMinor := match[1]
    majorMinorSplit := strings.Split(majorMinor, ".")
    if len(majorMinorSplit) < 2 {
        return "Unknown version format"
    }

    major, err1 := strconv.Atoi(majorMinorSplit[0])
    minor, err2 := strconv.Atoi(majorMinorSplit[1])
    if err1 != nil || err2 != nil {
        return "Unknown version format"
    }

    if major < 4 || (major == 4 && minor < 4) {
        return "Vulnerable unless patched for CVE-2006-5051 and CVE-2008-4109"
    } else if (major == 4 && minor >= 4) || (major > 4 && major < 8) || (major == 8 && minor < 5) {
        return "Not vulnerable"
    } else if (major == 8 && minor >= 5) || (major > 8 && major < 9) || (major == 9 && minor < 8) {
        return "Vulnerable"
    } else {
        return "Not vulnerable"
    }
}

func main() {
    fmt.Println("CVE-2024-6387 OpenSSH Vulnerability Checker")
    fmt.Println("------------------------------------------")
    fmt.Println("This script has been tested on Ubuntu and Mac and Windows11 systems.")
    fmt.Println("The script results are for reference only.")
    fmt.Println("For a thorough security assessment, consult with a security expert.")
    fmt.Println("If a vulnerable version is detected, consult with your system administrator to apply appropriate updates or patches.")
    fmt.Println("------------------------------------------")
    fmt.Println("OpenSSH versions earlier than 4.4p1 are vulnerable unless patched for CVE-2006-5051 or CVE-2008-4109.")
    fmt.Println("OpenSSH 4.4p1 or later, but not earlier than 8.5p1, is not vulnerable.")
    fmt.Println("OpenSSH 8.5p1 and later, but not earlier than 9.8p1, are again vulnerable.")
    fmt.Println("------------------------------------------")

    // Get and print the OpenSSH version
    versionInfo := getOpenSSHVersion()
    fmt.Printf("OpenSSH version info: %s\n", versionInfo)

    // Check if the version is vulnerable
    vulnerabilityStatus := isVulnerable(versionInfo)
    fmt.Printf("Vulnerability status: %s\n", vulnerabilityStatus)
}
