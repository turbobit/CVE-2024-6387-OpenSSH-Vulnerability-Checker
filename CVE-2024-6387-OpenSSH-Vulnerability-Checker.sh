#!/bin/bash

# Function to get the installed OpenSSH version
get_openssh_version() {
    version_info=$(ssh -V 2>&1)
    echo $version_info
}

# Function to check if the version is vulnerable
is_vulnerable() {
    version_info=$1
    version_number=$(echo $version_info | awk '{print $1}' | cut -d'_' -f2 | cut -d' ' -f1)
    
    major=$(echo $version_number | cut -d'.' -f1)
    minor=$(echo $version_number | cut -d'.' -f2 | grep -o '^[0-9]*')
    patch=$(echo $version_number | grep -o 'p[0-9]*' | sed 's/p//')
    
    if (( major < 4 )) || (( major == 4 && minor < 4 )); then
        echo "Vulnerable unless patched for CVE-2006-5051 and CVE-2008-4109"
    elif (( major == 4 && minor >= 4 )) || (( major > 4 && major < 8 )) || (( major == 8 && minor < 5 )); then
        echo "Not vulnerable"
    elif (( major == 8 && minor >= 5 )) || (( major > 8 && major < 9 )) || (( major == 9 && minor < 8 )); then
        echo "Vulnerable"
    else
        echo "Not vulnerable"
    fi
}

echo "CVE-2024-6387 OpenSSH Vulnerability Checker"
echo "------------------------------------------"
echo "This script has been tested on Ubuntu and Mac systems."
echo "The script results are for reference only."
echo "For a thorough security assessment, consult with a security expert."
echo "If a vulnerable version is detected, consult with your system administrator to apply appropriate updates or patches."
echo "------------------------------------------"
echo "OpenSSH versions earlier than 4.4p1 are vulnerable unless patched for CVE-2006-5051 or CVE-2008-4109."
echo "OpenSSH 4.4p1 or later, but not earlier than 8.5p1, is not vulnerable."
echo "OpenSSH 8.5p1 and later, but not earlier than 9.8p1, are again vulnerable."
echo "------------------------------------------"

# Get and print the OpenSSH version
version_info=$(get_openssh_version)
echo "OpenSSH version info: $version_info"

# Check if the version is vulnerable
vulnerability_status=$(is_vulnerable "$version_info")
echo "Vulnerability status: $vulnerability_status"
