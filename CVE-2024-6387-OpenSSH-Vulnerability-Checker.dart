import 'dart:convert';
import 'dart:io';

Future<String> getOpenSSHVersion() async {
  try {
    ProcessResult result = await Process.run('ssh', ['-V']);
    String versionInfo = result.stderr.toString().trim();
    return versionInfo;
  } catch (e) {
    return 'Error retrieving OpenSSH version: $e';
  }
}

String isVulnerable(String versionInfo) {
  RegExp regExp = RegExp(r'OpenSSH(?:_for_Windows)?_([\d\.]+)p(\d+)');
  Match? match = regExp.firstMatch(versionInfo);

  if (match == null) {
    return 'Unknown version format';
  }

  String majorMinor = match.group(1)!;
  int patch = int.parse(match.group(2)!);
  List<String> majorMinorParts = majorMinor.split('.');
  int major = int.parse(majorMinorParts[0]);
  int minor = int.parse(majorMinorParts[1]);

  if (major < 4 || (major == 4 && minor < 4)) {
    return 'Vulnerable unless patched for CVE-2006-5051 and CVE-2008-4109';
  } else if ((major == 4 && minor >= 4) || (major > 4 && major < 8) || (major == 8 && minor < 5)) {
    return 'Not vulnerable';
  } else if ((major == 8 && minor >= 5) || (major > 8 && major < 9) || (major == 9 && minor < 8)) {
    return 'Vulnerable';
  } else {
    return 'Not vulnerable';
  }
}

void main() async {
  print('CVE-2024-6387 OpenSSH Vulnerability Checker');
  print('------------------------------------------');
  print('This script has been tested on Ubuntu and Mac and Windows11 systems.');
  print('The script results are for reference only.');
  print('For a thorough security assessment, consult with a security expert.');
  print('If a vulnerable version is detected, consult with your system administrator to apply appropriate updates or patches.');
  print('------------------------------------------');
  print('OpenSSH versions earlier than 4.4p1 are vulnerable unless patched for CVE-2006-5051 or CVE-2008-4109.');
  print('OpenSSH 4.4p1 or later, but not earlier than 8.5p1, is not vulnerable.');
  print('OpenSSH 8.5p1 and later, but not earlier than 9.8p1, are again vulnerable.');
  print('------------------------------------------');

  String versionInfo = await getOpenSSHVersion();
  print('OpenSSH version info: $versionInfo');

  String vulnerabilityStatus = isVulnerable(versionInfo);
  print('Vulnerability status: $vulnerabilityStatus');
}
